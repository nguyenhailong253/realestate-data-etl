version: 2.1

orbs:
  python: circleci/python@2.1.1
  aws-ecr: circleci/aws-ecr@8.1.3

parameters:
  num_ads_processed_per_build:
    type: integer
    default: 2300 # CircleCI can complete about 2300 ads per hour which is its free-tier runtime limit
  batch_2_offset:
    type: integer
    default: 2300
  batch_3_offset:
    type: integer
    default: 4600
  batch_4_offset:
    type: integer
    default: 6900
  batch_5_offset:
    type: integer
    default: 9200

jobs:
  unit-test:
    executor: python/default
    steps:
      - checkout
      - python/install-packages:
          args: pytest
          pkg-manager: pipenv
      - run:
          name: "Running unit tests..."
          # https://stackoverflow.com/questions/10253826/path-issue-with-pytest-importerror-no-module-named-yadayadayada
          command: "pipenv run python -m pytest ./tests/ -s"
  etl:
    executor: python/default
    steps:
      - checkout
      - python/install-packages:
          args: pytest
          pkg-manager: pipenv
      - run:
          name: "ETL process for existing data from raw tables"
          command: pipenv run python3 -m src.main

workflows:
  realestate-etl-pipeline:
    # when:
    #   and:
    #     - not:
    #         equal: ["update-ad-schedule", << pipeline.schedule.name >>]
    #     - not:
    #         equal: ["update-agency-schedule", << pipeline.schedule.name >>]
    jobs:
      - unit-test
      - etl:
          requires:
            - unit-test
          filters:
            branches:
              only:
                - master
